{
  "version": "0.1",
  "name": "BRK2",
  "catalogue": "brk2",
  "source": {
    "application": "Neuron"
  },
  "destination": {
    "application": "GOBPrepare"
  },
  "publish_schemas": {
    "brk2_prep": "brk2_prepared"
  },
  "actions": [
    {
      "type": "clear",
      "schemas": [
        "brk2",
        "brk2_prep"
      ],
      "id": "clear_schemas"
    },
    {
      "type": "select",
      "source": "src",
      "query": [
        "         SELECT TRUNC(MAX(BSD.DATUM_AANGEMAAKT)) AS brk_bsd_toestandsdatum",
        "         ,      'Toestandsdatum, d.i. de laatste aanmaakdatum van de BRK-berichten in de naar DIVA gerepliceerde BRK-levering.' AS omschrijving",
        "           FROM   G0363_BRK2MON.BESTAND BSD"
      ],
      "query_src": "string",
      "destination_table": {
        "name": "brk.bestand",
        "create": true,
        "columns": [
          {
            "name": "brk_bsd_toestandsdatum",
            "type": "TIMESTAMP"
          },
          {
            "name": "omschrijving",
            "type": "VARCHAR(120)"
          }
        ]
      },
      "depends_on": [
        "clear_schemas"
      ],
      "id": "create_bestand_table"
    },
    {
      "type": "clone",
      "source_schema": "G0363_BRK2",
      "destination_schema": "brk2",
      "id_columns": {
        "_defaults": [
          ["ID", "VOLGNUMMER"],
          ["ID"],
          ["CODE"],
          ["KADASTRAALOBJECT_ID", "KADASTRAALOBJECT_VOLGNUMMER"],
          ["ZAKELIJKRECHT_ID"],
          ["TENAAMSTELLING_ID"],
          ["MUTATIE_ID"]
        ],
        "AANTEKENING_BETROKKENPERSOON": [
          "AANTEKENING_ID"
        ],
        "ADRESSEERBAAR_NEVENADRES": [
          "ADRESSEERBAAR_OBJECT_ID"
        ],
        "MANDELIGHEID_ISGEBASEERDOP": [
          "MANDELIGHEID_ID"
        ],
        "PUBLIEKRECHTELIJKE_GEZAG": [
          "BEPERKING_ID"
        ]
      },
      "ignore": [
        "VERSIE"
      ],
      "depends_on": [
        "clear_schemas"
      ],
      "id": "clone_source"
    },
    {
      "type": "import_csv",
      "source": "https://developer.kadaster.nl/schemas/waardelijsten/CultuurcodeOnbebouwd/CultuurcodeOnbebouwd.csv",
      "destination": "brk2.import_cultuur_onbebouwd",
      "column_names": {
        "Code": "code",
        "Waarde": "omschrijving",
        "DatumVanaf": "datum_vanaf",
        "DatumTot": "datum_tot",
        "Toelichting": "type"
      },
      "id": "import_cultuur_onbebouwd_csv",
      "depends_on": [
        "clear_schemas"
      ]
    },
    {
      "type": "import_csv",
      "source": "https://developer.kadaster.nl/schemas/waardelijsten/BurgemKadgemSectie/BurgemKadgemSectie.csv",
      "destination": "brk2.import_burgerlijke_gemeentes",
      "id": "import_burgerlijke_gemeentes",
      "depends_on": [
        "clear_schemas"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Create materialized view Baghulptabel",
      "query_src": "file",
      "query": "data/sql/brk2/materialized_view.baghulptabel.sql",
      "id": "create_baghulptabel",
      "depends_on": [
        "clone_source"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Select meta",
      "query_src": "file",
      "query": "data/sql/brk2/select.meta.sql",
      "id": "select_meta",
      "depends_on": [
        "create_bestand_table"
      ]
    },
    {
      "type":"execute_sql",
      "description": "Select KOT",
      "query_src": "file",
      "query": "data/sql/brk2/select.kadastraal_object.sql",
      "id": "select_kot",
      "depends_on": [
        "clone_source",
        "import_cultuur_onbebouwd_csv",
        "import_burgerlijke_gemeentes",
        "create_baghulptabel"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Select ZRT",
      "query_src": "file",
      "query": "data/sql/brk2/select.zakelijk_recht.sql",
      "id": "select_zrt",
      "depends_on": [
        "select_kot"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Populate ZRT table with KOT references",
      "id": "populate_zrt",
      "depends_on": [
        "select_zrt"
      ],
      "query_src": "file",
      "query": "data/sql/brk2/zrt.add_kot.sql"
    },
    {
      "type": "execute_sql",
      "description": "KOT - Set is_ontstaan_uit_kadastraalobject",
      "id": "set_is_ontstaan_uit_kadastraalobject",
      "depends_on": [
        "populate_zrt"
      ],
      "query_src": "file",
      "query": "data/sql/brk2/kot.set_is_ontstaan_uit_kadastraalobject.sql"
    },
    {
      "type": "execute_sql",
      "description": "Create references between ZRT's on betrokken_bij and ontstaan_uit",
      "id": "create_zrt_references",
      "depends_on": [
        "populate_zrt"
      ],
      "query_src": "file",
      "query": "data/sql/brk2/zrt.reference_ontstaan_uit_betrokken_bij.sql"
    },
    {
      "type": "execute_sql",
      "description": "KOT - Set is_ontstaan_uit_g_perceel",
      "id": "set_is_ontstaan_uit_g_perceel",
      "depends_on": [
        "populate_zrt"
      ],
      "query_src": "file",
      "query": "data/sql/brk2/kot.set_is_ontstaan_uit_g_perceel.sql"
    }
  ]
}
