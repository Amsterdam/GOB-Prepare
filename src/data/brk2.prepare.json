{
  "version": "0.1",
  "name": "BRK2",
  "catalogue": "brk2",
  "destination": {
    "application": "GOBPrepare"
  },
  "actions": [
    {
      "type": "clear",
      "schemas": [
        "brk2_prep"
      ],
      "id": "clear_schemas"
    },
    {
      "type": "import_csv",
      "source": "https://developer.kadaster.nl/schemas/waardelijsten/BurgemKadgemSectie/BurgemKadgemSectie.csv",
      "destination": "brk2_prep.import_burgerlijke_gemeentes",
      "id": "import_burgerlijke_gemeentes",
      "depends_on": [
        "clear_schemas"
      ]
    },
    {
      "type": "import_csv",
      "objectstore": "Basisinformatie",
      "read_config": {
        "file_filter": "brk/Gemeentegrenzen_GML/gemeentes_2013_2022_incl_Weesp.csv",
        "container": "acceptatie"
      },
      "separator": ",",
      "destination": "brk2_prep.import_gemeentes_2013_2022",
      "id": "import_gemeentes_csv",
      "depends_on": [
        "clear_schemas"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Create materialized view Baghulptabel",
      "query_src": "file",
      "query": "data/sql/brk2/materialized_view.baghulptabel.sql",
      "id": "create_baghulptabel",
      "depends_on": [
        "clear_schemas"
      ]
    },
    {
      "type": "import_csv",
      "source": "https://developer.kadaster.nl/schemas/waardelijsten/AardAantekening/AardAantekening.csv",
      "destination": "brk2_prep.import_aardaantekening",
      "column_names": {
        "Code": "code",
        "Waarde": "omschrijving",
        "DatumVanaf": "datum_vanaf",
        "DatumTot": "datum_tot",
        "Toelichting": "type"
      },
      "id": "import_aardaantekening_csv",
      "depends_on": [
        "clear_schemas"
      ]
    },
    {
      "type": "import_csv",
      "source": "https://developer.kadaster.nl/schemas/waardelijsten/AardZakelijkRecht/AardZakelijkRecht.csv",
      "destination": "brk2_prep.aardzakelijkrecht_waardelijst_import",
      "id": "import_aardzakelijkrecht_waardelijst",
      "depends_on": [
        "clear_schemas"
      ]
    },
    {
      "type": "create_table",
      "description": "Populate AZT with AKR codes",
      "id": "populate_aardzakelijkrecht_waardelijst",
      "table_name": "brk2_prep.aardzakelijkrecht_waardelijst",
      "depends_on": [
        "import_aardzakelijkrecht_waardelijst"
      ],
      "query_src": "file",
      "query": "data/sql/brk2/select.aardzakelijkrecht_waardelijst.sql"
    },
    {
      "type": "import_csv",
      "objectstore": "Basisinformatie",
      "read_config": {
        "file_filter": "^brk/Oude_Nieuwe_ids/Conversietabel_BRK1_2_Identificaties.csv$",
        "container": "acceptatie"
      },
      "separator": ",",
      "destination": "brk2_prep.id_conversion",
      "id": "import_id_conversion_csv",
      "depends_on": [
        "clear_schemas"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Select meta",
      "query_src": "file",
      "query": "data/sql/brk2/select.meta.sql",
      "id": "select_meta",
      "depends_on": [
        "clear_schemas"
      ]
    },
    {
      "type": "create_table",
      "description": "Select kot_geldigheid",
      "table_name": "brk2_prep.kot_geldigheid",
      "query_src": "file",
      "query": "data/sql/brk2/preselect.kot.geldigheid.sql",
      "id": "select_kot_geldigheid",
      "depends_on": [
        "clear_schemas",
        "import_burgerlijke_gemeentes",
        "create_baghulptabel"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Select KOT",
      "query_src": "file",
      "query": "data/sql/brk2/select.kadastraal_object.sql",
      "id": "select_kot",
      "depends_on": [
        "select_kot_geldigheid"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Create zrt_kot_wip table",
      "id": "preselect_zrt_kot_generate",
      "query_src": "file",
      "query": "data/sql/brk2/preselect.zrt_kot_wip.sql",
      "depends_on": [
        "select_kot"
      ]
    },
    {
      "type": "create_table",
      "description": "Copy zrt_kot_wip table to zrt_kot",
      "id": "preselect_zrt_kot",
      "query_src": "file",
      "query": "data/sql/brk2/preselect.zrt_kot.sql",
      "depends_on": [
        "preselect_zrt_kot_generate"
      ],
      "table_name": "brk2_prep.zrt_kot"
    },
    {
      "type": "create_table",
      "description": "Create zrt_asg table",
      "id": "preselect_zrt_asg",
      "query_src": "file",
      "query": "data/sql/brk2/preselect.zrt_asg.sql",
      "depends_on": [
        "preselect_zrt_kot"
      ],
      "table_name": "brk2_prep.zrt_asg"
    },
    {
      "type": "execute_sql",
      "description": "Select ZRT",
      "query_src": "file",
      "query": "data/sql/brk2/select.zakelijk_recht.sql",
      "id": "select_zrt",
      "depends_on": [
        "preselect_zrt_kot",
        "preselect_zrt_asg",
        "import_id_conversion_csv"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Select Erfpachtcanon",
      "query_src": "file",
      "query": "data/sql/brk2/select.erfpachtcanon.sql",
      "id": "select_ec",
      "depends_on": [
        "select_zrt"
      ]
    },
    {
      "type": "create_table",
      "description": "KOT - is_ontstaan_uit_kadastraalobject",
      "table_name": "brk2_prep.kot_ontstaan_uit_kot",
      "id": "set_is_ontstaan_uit_kadastraalobject",
      "depends_on": [
        "select_kot",
        "select_zrt"
      ],
      "query_src": "file",
      "query": "data/sql/brk2/preselect.kot.is_ontstaan_uit_kadastraalobject.sql"
    },
    {
      "type": "execute_sql",
      "description": "KOT - Set is_ontstaan_uit_g_perceel",
      "id": "set_is_ontstaan_uit_g_perceel",
      "depends_on": [
        "select_kot",
        "select_zrt"
      ],
      "query_src": "file",
      "query": "data/sql/brk2/preselect.kot.is_ontstaan_uit_g_perceel.sql"
    },
    {
      "type": "import_api",
      "description": "Import BAG geometrie van verblijfsobjecten",
      "id": "import_verblijfsobjecten_geometrie",
      "depends_on": [
        "clear_schemas"
      ],
      "query_src": "file",
      "query": "data/api/bag/verblijfsobjecten_geometrie_import.graphql",
      "meta_type": "bag_verblijfsobjectenRootObjectType",
      "schema": "bag_brk2",
      "destination": "verblijfsobjecten_geometrie"
    },
    {
      "type": "execute_sql",
      "description": "Generate geometrie voor actuele appartementsrechten",
      "id": "update_geometrie_appartementsrechten",
      "depends_on": [
        "import_verblijfsobjecten_geometrie",
        "set_is_ontstaan_uit_g_perceel"
      ],
      "query_src": "file",
      "query": "data/sql/brk2/preselect.kot_geo.sql"
    },
    {
      "type": "execute_sql",
      "description": "Remove duplicate g-perceel relations",
      "id": "remove_duplicate_g_perceel_relations",
      "depends_on": [
        "update_geometrie_appartementsrechten"
      ],
      "query_src": "file",
      "query": "data/sql/brk2/kot.is_ontstaan_uit_g_perceel.unduplicate.sql"
    },
    {
      "type": "execute_sql",
      "description": "Finalise KOT table",
      "id": "finalise_kot",
      "depends_on": [
        "remove_duplicate_g_perceel_relations",
        "set_is_ontstaan_uit_kadastraalobject"
      ],
      "query_src": "file",
      "query": "data/sql/brk2/finalise.kadastraal_object.sql"
    },
    {
      "type": "execute_sql",
      "description": "Select TNG",
      "query_src": "file",
      "query": "data/sql/brk2/select.tenaamstelling.sql",
      "id": "select_tng",
      "depends_on": [
        "select_zrt"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Select AKT",
      "query_src": "file",
      "query": "data/sql/brk2/select.aantekening_kadastraal_object.sql",
      "id": "select_akt",
      "depends_on": [
        "select_kot",
        "import_aardaantekening_csv",
        "import_id_conversion_csv"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Select ART",
      "query_src": "file",
      "query": "data/sql/brk2/select.aantekening_recht.sql",
      "id": "select_art",
      "depends_on": [
        "select_tng"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Create materialized view subject_expiration_date",
      "id": "create_view_subject_actueel",
      "depends_on": [
        "select_akt",
        "select_art",
        "select_zrt"
      ],
      "query": "data/sql/brk2/materialized_view.subject_expiration_date.sql",
      "query_src": "file"
    },
    {
      "type": "execute_sql",
      "description": "Select SJT",
      "query_src": "file",
      "query": "data/sql/brk2/select.kadastraal_subject.sql",
      "id": "select_sjt",
      "depends_on": [
        "select_meta",
        "create_view_subject_actueel",
        "select_tng",
        "select_zrt"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Select KSE",
      "query_src": "file",
      "query": "data/sql/brk2/select.kadastrale_sectie.sql",
      "id": "select_kse",
      "depends_on": [
        "finalise_kot"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Select KGE",
      "query_src": "file",
      "query": "data/sql/brk2/select.kadastrale_gemeente.sql",
      "id": "select_kge",
      "depends_on": [
        "finalise_kot"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Select KCE",
      "query_src": "file",
      "query": "data/sql/brk2/select.kadastrale_gemeentecode.sql",
      "id": "select_kce",
      "depends_on": [
        "finalise_kot"
      ]
    },
    {
      "type": "execute_sql",
      "description": "Select SDL",
      "query_src": "file",
      "query": "data/sql/brk2/select.stukdeel.sql",
      "id": "select_sdl",
      "depends_on": [
        "select_meta",
        "select_art",
        "select_akt",
        "select_tng",
        "select_zrt",
        "select_ec"
      ]
    },
    {
      "type": "publish_schemas",
      "id": "publish_schemas",
      "publish_schemas": {
        "brk2_prep": "brk2_prepared"
      },
      "depends_on": "*"
    }
  ]
}
